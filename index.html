<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Kalkulator wcześniejszej spłaty kredytu</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f4f6f8; padding: 20px; }
        .container {
            max-width: 760px; background: #fff; padding: 20px; margin: auto;
            border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1 { text-align: center; }
        label { display: block; margin-top: 15px; }
        input, textarea, select { width: 100%; padding: 8px; margin-top: 5px; box-sizing: border-box; }
        textarea { min-height: 90px; }
        button {
            margin-top: 20px; width: 100%; padding: 10px; background: #007bff;
            color: white; border: none; font-size: 16px; cursor: pointer;
        }
        button:hover { background: #0056b3; }
        .result { margin-top: 20px; background: #eef; padding: 15px; border-radius: 5px; }
        .hint { font-size: 13px; color: #555; margin-top: 6px; line-height: 1.3; }
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        @media (max-width: 720px) { .row { grid-template-columns: 1fr; } }
        hr { margin: 18px 0; }
    </style>
</head>
<body>

<div class="container">
    <h1>Kalkulator nadpłaty kredytu</h1>

    <div class="row">
        <label>Kwota kredytu (PLN)
            <input type="number" id="loanAmount" placeholder="np. 400000">
        </label>

        <label>Oprocentowanie roczne (%)
            <input type="number" step="0.01" id="interestRate" placeholder="np. 7.25">
        </label>
    </div>

    <div class="row">
        <label>Okres kredytu (lata)
            <input type="number" id="years" placeholder="np. 25">
        </label>

        <label>Tryb nadpłaty
            <select id="mode">
                <option value="shorten">Skróć okres (stała rata)</option>
                <option value="lower">Zmniejsz ratę (stały okres)</option>
            </select>
            <div class="hint">
                „Skróć okres” – rata nie zmienia się, szybciej spłacasz.<br>
                „Zmniejsz ratę” – okres bez zmian, rata spada.
            </div>
        </label>
    </div>

    <hr>

    <label>Ile rat już spłacono? (miesięcy)
        <input type="number" id="paidMonths" value="0" min="0">
        <div class="hint">Jeśli podasz historię spłat poniżej, dopasuj liczbę miesięcy do liczby kwot.</div>
    </label>

    <label>Historia spłat (miesiąc po miesiącu) – kwoty PLN, oddzielone przecinkami lub w nowych liniach
        <textarea id="paymentsHistory" placeholder="np. 2500, 2500, 3000&#10;albo&#10;2500&#10;2500&#10;3000"></textarea>
        <div class="hint">
            Każda kwota to realna wpłata w danym miesiącu.<br>
            Jeśli wpłata > rata – różnica działa jak nadpłata w tym miesiącu.
        </div>
    </label>

    <hr>

    <label>Kwota nadpłaty jednorazowej (PLN) (po wykonaniu historii spłat)
        <input type="number" id="overpayment" value="0" min="0">
    </label>

    <button onclick="calculate()">Oblicz</button>

    <div class="result" id="result"></div>
</div>

<script>
function parsePayments(text) {
    if (!text || !text.trim()) return [];
    return text
        .replace(/\n/g, ',')
        .split(',')
        .map(x => x.trim())
        .filter(x => x.length > 0)
        .map(x => Number(x.replace(',', '.')))
        .filter(x => Number.isFinite(x) && x >= 0);
}

function annuityInstallment(loan, monthlyRate, months) {
    if (months <= 0) return 0;
    if (monthlyRate === 0) return loan / months;
    const pow = Math.pow(1 + monthlyRate, months);
    return loan * (monthlyRate * pow) / (pow - 1);
}

function simulateConstantPayment(balance, monthlyRate, payment) {
    // Zwraca: { newBalance, interest, principalPaid, paymentUsed }
    const interest = balance * monthlyRate;
    const maxPay = balance + interest;
    const paymentUsed = Math.min(payment, maxPay);
    const principalPaid = Math.max(0, paymentUsed - interest);
    const newBalance = Math.max(0, balance - principalPaid);
    return { newBalance, interest, principalPaid, paymentUsed };
}

function calculateBaseline(loan, monthlyRate, months) {
    const installment = annuityInstallment(loan, monthlyRate, months);
    let balance = loan, totalInterest = 0, m = 0;

    while (balance > 1e-8 && m < 5000) {
        const step = simulateConstantPayment(balance, monthlyRate, installment);
        totalInterest += step.interest;
        balance = step.newBalance;
        m++;
    }
    return { installment, totalInterest, monthsActual: m };
}

function calculate() {
    const loan = parseFloat(document.getElementById('loanAmount').value);
    const monthlyRate = parseFloat(document.getElementById('interestRate').value) / 100 / 12;
    const years = parseInt(document.getElementById('years').value, 10);
    const monthsTotal = years * 12;

    const mode = document.getElementById('mode').value; // shorten | lower
    const paidMonths = Math.max(0, parseInt(document.getElementById('paidMonths').value || "0", 10));
    const history = parsePayments(document.getElementById('paymentsHistory').value);
    const overpayment = Math.max(0, parseFloat(document.getElementById('overpayment').value || "0"));

    if (!Number.isFinite(loan) || loan <= 0 ||
        !Number.isFinite(monthlyRate) || monthlyRate < 0 ||
        !Number.isFinite(monthsTotal) || monthsTotal <= 0) {
        document.getElementById('result').innerHTML = 'Uzupełnij poprawnie dane wejściowe.';
        return;
    }

    // Bazowy scenariusz: brak historii + brak nadpłat
    const base = calculateBaseline(loan, monthlyRate, monthsTotal);
    const baseInstallment = base.installment;

    // --- Scenariusz: historia + nadpłata ---
    let balance = loan;
    let totalInterestAfter = 0;
    let monthsCount = 0;

    // 1) Historia spłat (useN pozycji)
    const useN = Math.min(paidMonths, history.length);

    for (let i = 0; i < useN && balance > 1e-8; i++) {
        const payment = history[i];
        const step = simulateConstantPayment(balance, monthlyRate, payment);
        totalInterestAfter += step.interest;
        balance = step.newBalance;
        monthsCount++;
    }

    // 2) Jeśli paidMonths > ilość wpisów, brakujące miesiące spłacamy bazową ratą
    const missing = Math.max(0, paidMonths - useN);
    for (let i = 0; i < missing && balance > 1e-8; i++) {
        const step = simulateConstantPayment(balance, monthlyRate, baseInstallment);
        totalInterestAfter += step.interest;
        balance = step.newBalance;
        monthsCount++;
    }

    // 3) Nadpłata jednorazowa po historii
    if (balance > 1e-8 && overpayment > 0) {
        balance = Math.max(0, balance - overpayment);
    }

    // 4) Co dalej zależy od trybu
    let newInstallment = baseInstallment;
    let monthsRemainingPlanned = Math.max(0, monthsTotal - monthsCount);

    if (balance <= 1e-8) {
        // spłacone w historii/nadpłacie
        newInstallment = 0;
    } else if (mode === "lower") {
        // Stały okres: przelicz nową ratę na pozostałe miesiące
        newInstallment = annuityInstallment(balance, monthlyRate, monthsRemainingPlanned);

        // Symuluj do końca pozostałych miesięcy (żeby policzyć odsetki dokładnie)
        for (let i = 0; i < monthsRemainingPlanned && balance > 1e-8; i++) {
            const step = simulateConstantPayment(balance, monthlyRate, newInstallment);
            totalInterestAfter += step.interest;
            balance = step.newBalance;
            monthsCount++;
        }

        // Jeżeli przez zaokrąglenia coś zostało, domknij
        let guard = 0;
        while (balance > 1e-8 && guard < 2000) {
            const step = simulateConstantPayment(balance, monthlyRate, newInstallment);
            totalInterestAfter += step.interest;
            balance = step.newBalance;
            monthsCount++;
            guard++;
        }
    } else {
        // Skróć okres: trzymaj ratę bazową i spłacaj aż do zera
        newInstallment = baseInstallment;
        let guard = 0;
        while (balance > 1e-8 && guard < 5000) {
            const step = simulateConstantPayment(balance, monthlyRate, newInstallment);
            totalInterestAfter += step.interest;
            balance = step.newBalance;
            monthsCount++;
            guard++;
        }
    }

    const savings = base.totalInterest - totalInterestAfter;
    const monthsSaved = base.monthsActual - monthsCount;

    const modeText = (mode === "lower")
        ? "Zmniejsz ratę (stały okres)"
        : "Skróć okres (stała rata)";

    document.getElementById('result').innerHTML = `
        <b>Tryb:</b> ${modeText}<br><br>

        <b>Rata bazowa:</b> ${baseInstallment.toFixed(2)} PLN<br>
        <b>Odsetki bez nadpłat:</b> ${base.totalInterest.toFixed(2)} PLN<br>
        <b>Okres bez nadpłat:</b> ${base.monthsActual} miesięcy<br><br>

        <b>Rata po zmianach:</b> ${newInstallment.toFixed(2)} PLN<br>
        <b>Odsetki po zmianach:</b> ${totalInterestAfter.toFixed(2)} PLN<br>
        <b>Nowy okres:</b> ${monthsCount} miesięcy<br><br>

        <b>Oszczędność na odsetkach:</b> ${savings.toFixed(2)} PLN<br>
        <b>Różnica w długości:</b> ${monthsSaved} miesięcy
    `;
}
</script>

</body>
</html>
